# tmux configuration.
# Window-focused workflow (panes are rarely used).
# Rosé Pine Moon palette to match nvim and wezterm.
# Prefix: Ctrl-a (more ergonomic than default Ctrl-b).

##### Prefix
unbind C-b
set -g prefix C-a
bind C-a send-prefix

##### Core behaviour
set -g base-index 1                 # windows start at 1, not 0
setw -g pane-base-index 1
set -g renumber-windows on          # fill gaps when windows are closed
set -g mouse on
set -g history-limit 100000
setw -g mode-keys vi
set -sg escape-time 10              # near-instant Esc (important for nvim)
set -g focus-events on              # let nvim detect focus changes

##### Terminal / colours
set -g default-terminal "tmux-256color"
set -as terminal-overrides ",*:Tc"  # true colour support

##### Keybindings
# Navigation — vim-style: h/l for windows, j/k for sessions
bind h previous-window
bind l next-window
bind j switch-client -n
bind k switch-client -p
bind w choose-tree -Zw              # full session/window overview

# Windows
bind c new-window -c "#{pane_current_path}"
bind q confirm-before -p "Kill window #W? (y/n)" kill-window
bind r command-prompt -I "#W" "rename-window '%%'"

# Sessions — Q kills the session but ensures tmux stays alive
# (spawns a new session first if it's the last one, so WezTerm doesn't close)
bind Q run-shell '\
    name="$(tmux display-message -p "#{session_name}")"; \
    if [ "$(tmux list-sessions | wc -l | tr -d " ")" -le 1 ]; then \
        tmux new-session -d; \
    fi; \
    tmux switch-client -n; \
    tmux kill-session -t "=$name"'
bind R command-prompt -I "#S" "rename-session '%%'"
bind f display-popup -E "~/.local/bin/tmux-sessionizer"

# Save / source
bind s run-shell "~/.config/tmux/plugins/tmux-resurrect/scripts/save.sh" \; display-message "Session saved"
bind S source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"

##### Clipboard
set -g set-clipboard on             # OSC52 clipboard passthrough

bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "\
  if command -v pbcopy >/dev/null 2>&1; then pbcopy; \
  elif command -v wl-copy >/dev/null 2>&1; then wl-copy; \
  elif command -v xclip >/dev/null 2>&1; then xclip -selection clipboard -in; \
  elif command -v xsel >/dev/null 2>&1; then xsel --clipboard --input; \
  else cat >/dev/null; fi"

##### Status bar (rose-pine-moon palette)
set -g status-style "bg=#232136,fg=#e0def4"
set -g status-left "#[fg=#c4a7e7,bold] #S "
set -g status-right "#[fg=#6e6a86] %H:%M "
set -g window-status-current-format "#[fg=#c4a7e7,bold] #I:#W "
set -g window-status-format "#[fg=#6e6a86] #I:#W "
set -g status-left-length 20
set -g status-position bottom
set -g pane-border-style "fg=#44415a"
set -g pane-active-border-style "fg=#c4a7e7"
set -g message-style "bg=#232136,fg=#e0def4"

##### TPM (Tmux Plugin Manager)
# Auto-clones TPM on first run; plugins install with prefix+I.
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins/'

if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm'"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @resurrect-capture-pane-contents 'on'    # restore visible pane content
set -g @continuum-restore 'on'                  # auto-restore on tmux start

# Initialise TPM (keep at very bottom)
run '~/.config/tmux/plugins/tpm/tpm'
